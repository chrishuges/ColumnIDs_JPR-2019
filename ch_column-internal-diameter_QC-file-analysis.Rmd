---
title: "Column Internal Diameters"
output: html_notebook
---

This document details the analysis of quality control data generated using RawTools for analysis of injections from different column internal diameters. 

<br>

### Data analysis and plotting

<br>

These are the R libraries we will require.

```{r, results = 'hide'}
library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(reshape2)
library(viridis)
```


<br>

First we need to get the QC output file generated by RawTools.

```{r}
###################################################################################################################################################################
#get the qc file
qc_data = read.table('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/qc_output-xtandem-run2/QcDataTable.csv', header = TRUE, sep = ',')
qc_data$column = sub(".*?unlabeled_(.*?)-20cm-19umDrM_direct_Std-1-[2,4]0_injection-[1-3]\\.raw", "\\1", qc_data$FileName)
qc_data$dilution = sub(".*?Std-(.*?)_injection-[1-3]\\.raw", "\\1", qc_data$FileName)
qc_data$replicate = sub(".*?injection-(.*?)\\.raw", "\\1", qc_data$FileName)

qc_data$column = factor(qc_data$column, levels = c('50um','100um','150um','200um'))
qc_data = subset(qc_data, qc_data$dilution == '1-40')
```


<br>

We can start plotting immediately here, looking at scan numbers first.

```{r}
###################################################################################################################################################################
#plot the scan numbers across replicates
output_plot = ggplot(qc_data, aes(column, NumMs2Scans, fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  labs(x = "Column Internal Diameter", y = 'Number of MS2 Scans', title = 'MS2 Scan Numbers') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,25000), breaks = seq(0,25000,5000)) 
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_MS2scan-number-across-replicates.pdf',output_plot)

mean(qc_data[grepl('50um', qc_data$column), "NumMs2Scans"], na.rm = TRUE)
```

<br>

MS1 intensities.

```{r}
###################################################################################################################################################################
#plot the MS1 intensities across replicates
output_plot = ggplot(qc_data, aes(column, log10(Ms1MedianSummedIntensity), fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'log10(Median Summed MS1 Intensity)', title = 'MS1 Intensity') +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,1))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_MS1-intensity-across-replicates.pdf',output_plot)

log10(mean(qc_data[grepl('50um', qc_data$column), "Ms1MedianSummedIntensity"], na.rm = TRUE))
```


<br>

MS2 intensities.

```{r}
###################################################################################################################################################################
#plot the MS2 intensities across replicates
output_plot = ggplot(qc_data, aes(column, log10(Ms2MedianSummedIntensity), fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'log10(Median Summed MS2 Intensity)', title = 'MS2 Intensity') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1)) 
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_MS2-intensity-across-replicates.pdf',output_plot)

log10(mean(qc_data[grepl('50um', qc_data$column), "Ms2MedianSummedIntensity"], na.rm = TRUE))
```


<br>

MS2 ion injection times.

```{r}
###################################################################################################################################################################
#plot the MS2 injection times across replicates
output_plot = ggplot(qc_data, aes(column, MedianMs2FillTime.ms., fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Median MS2 Ion Injection Time (ms)', title = 'MS2 Ion Injection Time') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,25), breaks = seq(0,25,5)) +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)])
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_MS2-injection-across-replicates.pdf',output_plot)

mean(qc_data[grepl('50um', qc_data$column), "MedianMs2FillTime.ms."], na.rm = TRUE)
```


<br>

ESI stability.

```{r}
###################################################################################################################################################################
#plot the esi stability across replicates
output_plot = ggplot(qc_data, aes(column, EsiInstabilityFlags.count., fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Number of MS1 Instability Counts', title = 'Electrospray Stability') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,20), breaks = seq(0,20,2))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_esi-stability-across-replicates.pdf',output_plot)

mean(qc_data[grepl('50um', qc_data$column), "EsiInstabilityFlags.count."], na.rm = TRUE)
```

<br>

Peak width.

```{r}
###################################################################################################################################################################
#plot the peak width at half height across replicates
output_plot = ggplot(qc_data, aes(column, WidthAt50.H.s., fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Peak Width (seconds)', title = 'Peak Width at Half Height') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,2))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_peak-width-half-across-replicates.pdf',output_plot)

mean(qc_data[grepl('50um', qc_data$column), "WidthAt50.H.s."], na.rm = TRUE)
```

<br>

Identification rate.

```{r}
###################################################################################################################################################################
#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(column, (IdentificationRate.IDs.Ms2Scan. * 100), fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Identification Rate (%)', title = 'MS2 Identification Rate') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_identification-rate-across-replicates.pdf',output_plot)

mean(qc_data[grepl('50um', qc_data$column), "IdentificationRate.IDs.Ms2Scan."], na.rm = TRUE)
```


<br>

Isolation interference.

```{r}
###################################################################################################################################################################
#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(column, (MedianMs1IsolationInterence * 100), fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Isolation Interference (%)', title = 'MS2 Isolation Interference') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_isolation-interference-across-replicates.pdf',output_plot)

mean(qc_data[grepl('50um', qc_data$column), "MedianMs1IsolationInterence"], na.rm = TRUE)
```

<br>

Precursor Intensity.

```{r}
###################################################################################################################################################################
#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(column, log10(MedianPrecursorIntensity), fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Median Precursor Intensity', title = 'Precursor Intensity') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_precursor-intensity-across-replicates.pdf',output_plot)

log10(mean(qc_data[grepl('50um', qc_data$column), "MedianPrecursorIntensity"], na.rm = TRUE))
```

The 150um column looks good in these data. Not sure what happened with the 100um packed column, it doesn't look as nice. 

Let's look at the efficiency scores.

```{r}
overheadTimes = c(51,51,51,11,11,11,8,8,8,8,8,8)
qc_data$acquisitionE = qc_data$NumMs2Scans / qc_data$TotalScans
qc_data$injectionE = qc_data$TotalAnalysisTime / (qc_data$TotalAnalysisTime + overheadTimes)
qc_data$MSE = qc_data$acquisitionE * qc_data$injectionE


#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(column, acquisitionE*100, fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Acquisition Efficiency (%)', title = 'Acquisition Efficiency') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_acquisition-efficiency-across-diameters.pdf',output_plot)


#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(column, injectionE*100, fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'Injection Efficiency (%)', title = 'Injection Efficiency') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_injection-efficiency-across-diameters.pdf',output_plot)

#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(column, MSE*100, fill = column)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Column Internal Diameter", y = 'MSE (%)', title = 'MS Efficiency') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/internal-diameters/Ranalysis/QC_MSE-across-diameters.pdf',output_plot)




#mean(qc_data$acquisitionE)
#mean(qc_data$injectionE)
#mean(qc_data$MSE)
```




















