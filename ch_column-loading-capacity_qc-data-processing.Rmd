---
title: "Column Loading Capacity"
output: html_notebook
---

This document details the analysis of quality control data generated using RawTools for analysis of injections from different column loading amounts. 

<br>

### Data analysis and plotting

<br>

These are the R libraries we will require.

```{r, results = 'hide'}
library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(reshape2)
library(viridis)
```


<br>

First we need to get the QC output file generated by RawTools.

```{r}
###################################################################################################################################################################
#get the qc file
qc_data = read.table('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/qc_output-xtandem-run2/QcDataTable.csv', header = TRUE, sep = ',')
qc_data$column = sub(".*?unlabeled_(.*?)-20cm-19umDrM_direct_Std-1-[5,10,20,40]+_loading-test-[1-3]\\.raw", "\\1", qc_data$FileName)
qc_data$dilution = sub(".*?Std-(.*?)_loading-test-[1-3]\\.raw", "\\1", qc_data$FileName)
qc_data$replicate = sub(".*?test-(.*?)\\.raw", "\\1", qc_data$FileName)

qc_data$dilution = factor(qc_data$dilution, levels = c('1-5','1-10','1-20','1-40'))
```


<br>

We can start plotting immediately here, looking at scan numbers first.

```{r}
###################################################################################################################################################################
#plot the scan numbers across replicates
output_plot = ggplot(qc_data, aes(dilution, NumMs2Scans, fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  labs(x = "Injection Load", y = 'Number of MS2 Scans', title = 'MS2 Scan Numbers') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  geom_hline(yintercept = 21360, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,25000), breaks = seq(0,25000,5000)) 
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_MS2scan-number-across-replicates.pdf',output_plot)
```

<br>

MS1 intensities.

```{r}
###################################################################################################################################################################
#plot the MS1 intensities across replicates
output_plot = ggplot(qc_data, aes(dilution, log10(Ms1MedianSummedIntensity), fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'log10(Median Summed MS1 Intensity)', title = 'MS1 Intensity') +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  geom_hline(yintercept = 7.71, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,1))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_MS1-intensity-across-replicates.pdf',output_plot)
```


<br>

MS2 intensities.

```{r}
###################################################################################################################################################################
#plot the MS2 intensities across replicates
output_plot = ggplot(qc_data, aes(dilution, log10(Ms2MedianSummedIntensity), fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'log10(Median Summed MS2 Intensity)', title = 'MS2 Intensity') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  geom_hline(yintercept = 6.07, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1)) 
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_MS2-intensity-across-replicates.pdf',output_plot)
```


<br>

MS2 ion injection times.

```{r}
###################################################################################################################################################################
#plot the MS2 injection times across replicates
output_plot = ggplot(qc_data, aes(dilution, MedianMs2FillTime.ms., fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'Median MS2 Ion Injection Time (ms)', title = 'MS2 Ion Injection Time') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,25), breaks = seq(0,25,5)) +
  geom_hline(yintercept = 22, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)])
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_MS2-injection-across-replicates.pdf',output_plot)
```


<br>

ESI stability.

```{r}
###################################################################################################################################################################
#plot the esi stability across replicates
output_plot = ggplot(qc_data, aes(dilution, EsiInstabilityFlags.count., fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'Number of MS1 Instability Counts', title = 'Electrospray Stability') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  geom_hline(yintercept = 0.83, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,2))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_esi-stability-across-replicates.pdf',output_plot)
```

<br>

Peak width.

```{r}
###################################################################################################################################################################
#plot the peak width at half height across replicates
output_plot = ggplot(qc_data, aes(dilution, WidthAt50.H.s., fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'Peak Width (seconds)', title = 'Peak Width at Half Height') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  geom_hline(yintercept = 3.61, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,2))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_peak-width-half-across-replicates.pdf',output_plot)
```

<br>

Identification rate.

```{r}
###################################################################################################################################################################
#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(dilution, (IdentificationRate.IDs.Ms2Scan. * 100), fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'Identification Rate (%)', title = 'MS2 Identification Rate') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  geom_hline(yintercept = 29.0, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,40), breaks = seq(0,40,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_identification-rate-across-replicates.pdf',output_plot)
```


<br>

Isolation interference.

```{r}
###################################################################################################################################################################
#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(dilution, (MedianMs1IsolationInterence * 100), fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'Isolation Interference (%)', title = 'MS2 Isolation Interference') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  geom_hline(yintercept = 18.4, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_isolation-interference-across-replicates.pdf',output_plot)
```

<br>

Precursor Intensity.

```{r}
###################################################################################################################################################################
#plot the identification rate across replicates
output_plot = ggplot(qc_data, aes(dilution, log10(MedianPrecursorIntensity), fill = dilution)) +
  geom_boxplot(color = 'grey60', fill = 'grey80') +
  geom_jitter(pch = 21, size = 3, color = 'black', alpha = 1) +
  labs(x = "Injection Load", y = 'Median Precursor Intensity', title = 'Precursor Intensity') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_fill_manual(values = brewer.pal(6, "Set3")[c(1,3,4,5)]) +
  geom_hline(yintercept = 6.2, size = 0.5, linetype = 'dashed', color = 'red', alpha = 0.75) +
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/loading-capacity/Ranalysis/QC_precursor-intensity-across-replicates.pdf',output_plot)
```

The 150um column looks good in these data. Not sure what happened with the 100um packed column, it doesn't look as nice. 

Last thing is MSE scores.


```{r}
###################################################################################################################################################################

qc_data$acquisitionE = qc_data$NumMs2Scans / qc_data$TotalScans
qc_data$injectionE = qc_data$TotalAnalysisTime / (qc_data$TotalAnalysisTime + 8)
qc_data$MSE = (qc_data$acquisitionE * qc_data$injectionE)

mean(qc_data[grepl('5',qc_data$dilution), 'MSE'])
mean(qc_data[grepl('10',qc_data$dilution), 'MSE'])
mean(qc_data[grepl('20',qc_data$dilution), 'MSE'])
mean(qc_data[grepl('40',qc_data$dilution), 'MSE'])

```







