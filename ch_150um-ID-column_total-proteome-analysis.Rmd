---
title: "Total Proteome Analysis"
output: html_notebook
---

This document details the analysis of quality control data generated using RawTools for total proteome analysis on the ion trap and orbitrap. 

<br>

### Data analysis and plotting

<br>

These are the R libraries we will require.

```{r, results = 'hide'}
library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(dplyr)
library(reshape2)
library(viridis)
library(data.table)
library(pheatmap)
```


<br>

First we need to get the QC output file generated by RawTools.

```{r}
###################################################################################################################################################################
#get the qc file
itms_data = read.table('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/itms-total-proteome/qc_output-xtandem-run2/QcDataTable.csv', header = TRUE, sep = ',')
itms_data$detector = 'itms'
otms_data = read.table('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/otms-total-proteome/qc_output-xtandem-run2/QcDataTable.csv', header = TRUE, sep = ',')
otms_data$detector = 'otms'

itms_data$fraction = sub(".*?frac(.*?)\\.raw", "\\1", itms_data$FileName)
otms_data$fraction = sub(".*?frac(.*?)\\.raw", "\\1", otms_data$FileName)

qc_data = rbind(itms_data,otms_data)
qc_data$fraction = factor(qc_data$fraction, levels = 1:24)
```


<br>

Plot the data for MSE.

```{r}
qc_data$acquisitionE = qc_data$NumMs2Scans / qc_data$TotalScans
qc_data$overheadTimes = 8
qc_data$injectionE = qc_data$TotalAnalysisTime / (qc_data$TotalAnalysisTime + qc_data$overheadTimes)
qc_data$MSE = (qc_data$acquisitionE * qc_data$injectionE)

#plot the injection efficiency
output_plot = ggplot(qc_data, aes(fraction, (MSE *100), group = detector, color = detector)) +
  geom_line() +
  geom_point(pch = 21, size = 1, alpha = 1) +
  scale_color_manual(values = c(brewer.pal(6,'Paired')[2], brewer.pal(6,'Paired')[6])) + 
  labs(x = "Fraction", y = 'MSE (%)', title = 'MS Efficiency') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10)) 
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/itms-total-proteome/Ranalysis/MSE-across-detectors.pdf',output_plot)
```

<br>

Make a heatmap for the fraction distribution.

```{r}
##########################################
#first we need all the easy scan data
itms_scan_files = list.files('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/itms-total-proteome/quant', pattern = 'Matrix.txt', full.names = TRUE)
itms_scan_all = data.frame()
for (i in 1:length(itms_scan_files)){
  itms_temp1 = read.table(itms_scan_files[i], header = TRUE, sep = '\t')
  itms_temp2 = itms_temp1 %>% 
    dplyr::select(MS2ScanNumber, ParentScanRetTime) #select columns
  itms_temp2$fraction = i
  itms_scan_all = rbind(itms_scan_all, itms_temp2)
}

itms_scan_all$fraction = factor(itms_scan_all$fraction, levels = 1:24)
itms_scan_all$MS2Num = 1
itms_scan_all$bin_group = cut(itms_scan_all$ParentScanRetTime, breaks = seq(0,52,1))
itms_scan_compress = setDT(itms_scan_all)[,lapply(.SD,sum,na.rm=TRUE), by = c('fraction','bin_group'),.SDcols='MS2Num']
setDF(itms_scan_compress)
itms_scan_ordered = itms_scan_compress[order(itms_scan_compress$bin_group),]
itms_scan_ordered$bin_start = as.numeric(sub('\\((.*?)\\,.*','\\1',itms_scan_ordered$bin_group))
itms_scan_ordered$bin_end = as.numeric(sub('.*\\,(.*?)\\].*','\\1',itms_scan_ordered$bin_group))
itms_scan_ordered$midTime = itms_scan_ordered$bin_start + 0.5

mat1 = as.data.frame(dcast(itms_scan_ordered, fraction ~ midTime, value.var = "MS2Num"))
row.names(mat1) = mat1$fraction
mat2 = as.matrix(mat1[,c(2:52)])

#make the breaks
mat_breaks = seq(1, 1300, by = 5)
break_cols = colorRampPalette(rev(brewer.pal(n = 6, name = "RdBu")))(length(mat_breaks))


#make the actual plot
pheatmap(mat2, color = break_cols, border_color = 'white', cluster_rows = FALSE, cluster_cols = FALSE, show_colnames = TRUE, show_rownames = TRUE,
         cellwidth = 5, cellheight = 5, fontsize = 6, gaps_row = NULL, gaps_col = NULL, breaks = mat_breaks, legend = TRUE,
         filename = '/projects/ptx_analysis/chughes/projects-current/morin_column-testing/itms-total-proteome/Ranalysis/itms-nano-fraction-heatmap.pdf'
)

```

Now for Orbitrap data.

```{r}
##########################################
#first we need all the easy scan data
itms_scan_files = list.files('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/otms-total-proteome/quant', pattern = 'Matrix.txt', full.names = TRUE)
itms_scan_all = data.frame()
for (i in 1:length(itms_scan_files)){
  itms_temp1 = read.table(itms_scan_files[i], header = TRUE, sep = '\t')
  itms_temp2 = itms_temp1 %>% 
    dplyr::select(MS2ScanNumber, ParentScanRetTime) #select columns
  itms_temp2$fraction = i
  itms_scan_all = rbind(itms_scan_all, itms_temp2)
}

itms_scan_all$fraction = factor(itms_scan_all$fraction, levels = 1:24)
itms_scan_all$MS2Num = 1
itms_scan_all$bin_group = cut(itms_scan_all$ParentScanRetTime, breaks = seq(0,52,1))
itms_scan_compress = setDT(itms_scan_all)[,lapply(.SD,sum,na.rm=TRUE), by = c('fraction','bin_group'),.SDcols='MS2Num']
setDF(itms_scan_compress)
itms_scan_ordered = itms_scan_compress[order(itms_scan_compress$bin_group),]
itms_scan_ordered$bin_start = as.numeric(sub('\\((.*?)\\,.*','\\1',itms_scan_ordered$bin_group))
itms_scan_ordered$bin_end = as.numeric(sub('.*\\,(.*?)\\].*','\\1',itms_scan_ordered$bin_group))
itms_scan_ordered$midTime = itms_scan_ordered$bin_start + 0.5

mat1 = as.data.frame(dcast(itms_scan_ordered, fraction ~ midTime, value.var = "MS2Num"))
row.names(mat1) = mat1$fraction
mat2 = as.matrix(mat1[,c(2:52)])

#make the breaks
mat_breaks = seq(1, 800, by = 5)
break_cols = colorRampPalette(rev(brewer.pal(n = 6, name = "RdBu")))(length(mat_breaks))


#make the actual plot
pheatmap(mat2, color = break_cols, border_color = 'white', cluster_rows = FALSE, cluster_cols = FALSE, show_colnames = TRUE, show_rownames = TRUE,
         cellwidth = 5, cellheight = 5, fontsize = 6, gaps_row = NULL, gaps_col = NULL, breaks = mat_breaks, legend = TRUE,
         filename = '/projects/ptx_analysis/chughes/projects-current/morin_column-testing/itms-total-proteome/Ranalysis/otms-nano-fraction-heatmap.pdf'
)

```


<br>

Do the efficiency calculations.

```{r}
###################################################################################################################################################################
#get the qc file
itms_qc = read.table('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/itms-total-proteome/qc_output-xtandem-run2/QcDataTable.csv', header = TRUE, sep = ',')

itms_qc$acquisitionE = itms_qc$NumMs2Scans / itms_qc$TotalScans
itms_qc$injectionE = itms_qc$TotalAnalysisTime / (itms_qc$TotalAnalysisTime + 8)
itms_qc$MSE = itms_qc$acquisitionE * itms_qc$injectionE

mean(itms_qc$acquisitionE)
mean(itms_qc$injectionE)
mean(itms_qc$MSE)


#get the qc file
otms_qc = read.table('/projects/ptx_analysis/chughes/projects-current/morin_column-testing/otms-total-proteome/qc_output-xtandem-run2/QcDataTable.csv', header = TRUE, sep = ',')

otms_qc$acquisitionE = otms_qc$NumMs2Scans / otms_qc$TotalScans
otms_qc$injectionE = otms_qc$TotalAnalysisTime / (otms_qc$TotalAnalysisTime + 8)
otms_qc$MSE = otms_qc$acquisitionE * otms_qc$injectionE

mean(otms_qc$acquisitionE)
mean(otms_qc$injectionE)
mean(otms_qc$MSE)



```




